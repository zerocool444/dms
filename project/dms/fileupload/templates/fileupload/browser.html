{% extends "fileupload/base.html" %}
{% load staticfiles %}
{% block style %}
<link rel="stylesheet" href="{% static 'fileupload/css/webix.css' %}" type="text/css">
<link rel="stylesheet" href="{% static 'fileupload/css/custom.css' %}" type="text/css">
{% endblock %}
{% block script %}
<script src="{% static 'fileupload/js/webix.js' %}" type="text/javascript"></script>
{% endblock %}
{% block content %}
<script type="text/javascript">
    $(document).ready(function() {

        $.getJSON('http://localhost:8000/api/filesystem/?parent=' + '')
        .done(function(data) {
            var entries = [];
            $.each(data, function(i, item) {
                $.each(this, function(k, v) {
                    var entry = {};
                    entry['tree_id'] = item['id'];
                    if (k == 'content_object') {
                        $.each(v, function(k, v) {
                            entry[k] = v;
                        });
                    }
                    if (entry['size']) {
                        // just to guarantee we're getting real objects
                        entries.push(entry);
                    }
                });
            });
            var browser = webix.ui({
                view: 'treetable',
                columns: [
                    { id: 'name', header: 'Name'},
                    { id: 'size', header: 'Size'},
                    { id: 'type', header: 'Type'},
                    { id: 'items', header: 'Items'},
                    { id: 'modified', header: 'Modified'},
                    { id: 'modified_by', header: 'Modified By'}, // Django user
                    // Not actually sure what this one is supposed to be.
                    // { id: 'metadata', header: 'Metadata'}
                ],
                data: entries,
                resizeColumn: true,
                showOverlay: "Loading",
                select: "row",
                multiselect: true,
            });
            browser.attachEvent('onItemDblClick', function(id, e, node) {
                e.preventDefault();
                item = browser.getItem(id);
                if (item['type'] == 'Folder') {
                    $.getJSON('http://localhost:8000/api/filesystem/?parent=' + item['tree_id'])
                    .done(function(data) {
                        var entries = [];
                        $.each(data, function(i, item) {
                            $.each(this, function(k, v) {
                                    var entry = {};
                                    entry['tree_id'] = item['id'];
                                    if (k == 'content_object') {
                                        $.each(v, function(k, v) {
                                            entry[k] = v;
                                        });
                                    }
                                    if (entry['size']) {
                                        // just to guarantee we're getting real objects
                                        entries.push(entry);
                                    }
                            });
                        });
                        browser.clearAll();
                        browser.parse(entries, 'json');
                    });
                } else {

                }
            });
        });
        //console.log(entries);
    });
</script>
{% endblock %}
